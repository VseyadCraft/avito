function TcsPay(){this.inProgress=!1,this.dynamicUpdateCallback=function(e,t){$("#card__summ").html(Math.floor(parseInt(t.amount)/100)+'<span class="card__summ_small">,'+String(t.amount).substring(String(t.amount).length-2)+' <div class="images__rub"></div></span>');var r=e.find(".description-container"),a=e.find(".order-id-container");r.text(t.description),a.text(t.orderId)}}TcsParameters={TERMINAL_KEY:"TerminalKey",IP:"IP",TOKEN:"Token",ERROR_CODE:"ErrorCode",MESSAGE:"Message",DETAILS:"Details",SUCCESS:"success",PAYMENT_URL:"PaymentURL",AMOUNT:"Amount",ORDER_ID:"OrderId",PAYMENT_ID:"PaymentId",MD:"MD",PAREQ:"PaReq",ACSURL:"ACSUrl",TERM_URL:"TermUrl",DESCRIPTION:"Description",PAY_FORM:"PayForm",DATA:"DATA",CUSTOMER_KEY:"CustomerKey",CURRENCY:"Currency",PAN:"PAN",EXP_DATE:"ExpDate",CARD_HOLDER:"CardHolder",CVV:"CVV",INFO_EMAIL:"InfoEmail",SEND_EMAIL:"SendEmail",CARD_DATA:"CardData",RECURRENT:"Recurrent",BILL:"isBill"},TcsConstants={CARD_DATA_PAIR_SEPARATOR:";",INIT_DATA_PAIR_SEPARATOR:"|",CARD_DATA_KEY_VALUE_SEPARATOR:"=",INIT_DATA_KEY_VALUE_SEPARATOR:"=",PAY_FORM_ID:"tcs-pay-form"},TcsConstants.CONNECTION_TIMEOUT_MS=6e4,TcsUrl={CONTEXT_URL:"https://securepay.tinkoff.ru/rest/",WEBSOCKET_CONTEXT_URL:"wss://securepay.tinkoff.ru/rest/socket/"},TcsUrl.INIT_URL=TcsUrl.CONTEXT_URL+"Init",TcsUrl.FINISH_AUTORIZE_URL=TcsUrl.CONTEXT_URL+"FinishAuthorize",TcsUrl.SUBMIT_3DS_URL=TcsUrl.CONTEXT_URL+"Submit3DSAuthorization",TcsUrl.UPDATE_INIT_URL=TcsUrl.WEBSOCKET_CONTEXT_URL+"dynamicUpdate",TcsPay.prototype.setMerchantSideParameters=function(e){this.amount=e.amount,this.orderId=e.orderId,this.description=e.description,this.currency=e.currency,this.payForm=e.payForm,this.customerKey=e.customerKey,this.data=e.data,this.payType=e.payType,this.terminalKey=e.terminalKey,this.terminalPassword=e.terminalPassword,this.rcaPublicKey=e.rcaPublicKey,this.no3dsOnSuccess=e.no3dsOnSuccess,this.recurrent=e.recurrent,this.bill=e.bill;var t=$("#"+TcsConstants.PAY_FORM_ID),r=this;t&&t.bind('submit',function(e){r.merchantFormSubmit(),e.preventDefault()})},TcsPay.prototype.setGenerateTokenFunction=function(e){this.generateToken=e},TcsPay.prototype.allowDynamicUpdates=function(e){this.allowDynamicUpdates=e},TcsPay.prototype.setUpdateCallback=function(e){this.dynamicUpdateCallback=e},TcsPay.prototype.closeDynamicUpdateSession=function(){this.updateParamsSocket&&this.updateParamsSocket.close()},TcsPay.prototype.setBankSideParameters=function(e,t){this.terminalKey=e,this.paymentId=t;var r=$("#"+TcsConstants.PAY_FORM_ID),a=this;if(r){if(a.allowDynamicUpdates){var n=new WebSocket(TcsUrl.UPDATE_INIT_URL);a.updateParamsSocket=n,n.onmessage=function(e){var s=JSON.parse(e.data);s&&(a.dynamicUpdateCallback(r,s),n.send('A'+t))},n.onopen=function(e){n.send('S'+t),console.log("Registered for updates "+t)},$(window).on("beforeunload",function(){a.closeDynamicUpdateSession()})}r.submit(function(e){a.bankFormSubmit(),e.preventDefault()})}},TcsPay.prototype.merchantFormSubmit=function(){var e=this;this.getIp(function(){e.init(function(t){e.paymentId=t[TcsParameters.PAYMENT_ID],e.merchantFormFinishAuthorize()})})},TcsPay.prototype.merchantFormFinishAuthorize=function(){function e(e){var r=e[TcsParameters.PAREQ],a=e[TcsParameters.MD],n=e[TcsParameters.ACSURL];if(r&&a&&n){var s={};s[TcsParameters.MD]=a,s[TcsParameters.PAREQ]=r,s[TcsParameters.TERM_URL]=TcsUrl.SUBMIT_3DS_URL,t.redirectWithForm(n,s)}else{if(!t.no3dsOnSuccess)throw"Authorize success handler not found";t.no3dsOnSuccess(e)}}var t=this,r=$("#"+TcsConstants.PAY_FORM_ID),a=this.getCardData(r),n=this.encryptCardData(a),s=r.find('#form-sendmail-checkbox').prop("checked"),i=r.find('#form-sendmail-input').val(),o={TerminalKey:this.terminalKey,PaymentId:this.paymentId,SendEmail:s,InfoEmail:i,CardData:n};if(this.ip&&(o[TcsParameters.IP]=this.ip),!this.terminalPassword)throw"terminalPassword must be set";if(!this.generateToken)throw"Generate token function not found";this.generateToken(o,function(r){o[TcsParameters.TOKEN]=r,t.ajaxCall(TcsUrl.FINISH_AUTORIZE_URL,o,e,"json")})},TcsPay.prototype.bankFormSubmit=function(){function e(e,t){for(var r=""+e;r.length<t;)r='0'+r;return r}var t=$("#"+TcsConstants.PAY_FORM_ID),r=this.getCardData(t),a=t.find('#form-sendmail-checkbox').prop("checked"),n=t.find('#form-sendmail-input').val(),s="Unknown OS";-1!=navigator.appVersion.indexOf("Win")&&(s="Windows"),-1!=navigator.appVersion.indexOf("Mac")&&(s="MacOS"),-1!=navigator.appVersion.indexOf("X11")&&(s="UNIX"),-1!=navigator.appVersion.indexOf("Linux")&&(s="Linux");var i=(new Date).getTimezoneOffset();i=(i<0?'+':'-')+e(parseInt(Math.abs(i/60),10),2)+e(Math.abs(i%60),2);var o=window.navigator.userLanguage||window.navigator.language,c='';navigator.userAgent&&(c+="|userAgent="+navigator.userAgent.replace('<','(').replace('>',')')),s&&(c+="|os="+s),c+="|browser=Unknown",c+="|screenSize="+screen.width+"x"+screen.height,i&&(c+="|timezone="+i),o&&(c+="|language="+o),document.referrer&&(c+="|iframe_url="+encodeURIComponent(document.referrer.substring(0,document.referrer.indexOf('?')))),'|'===c.charAt(0)&&(c=c.substr(1));var T={TerminalKey:this.terminalKey,PaymentId:this.paymentId,SendEmail:a,CardData:r,DATA:c};n&&document.getElementById("form-sendmail-checkbox").checked&&(T.InfoEmail=n),this.ajaxCall(TcsUrl.FINISH_AUTORIZE_URL,T,function(e){var t=$('<div />').html(e),r=t.find('form[name="redirectForm"]');if(r.length)$(document.body).append(r),r.submit();else{var a=t.find('script');a.length?$(document.body).append(a):alert("Form 'redirectForm' not found")}})},TcsPay.prototype.init=function(e){var t=this,r=this.concatenateData(this.data,TcsConstants.INIT_DATA_KEY_VALUE_SEPARATOR,TcsConstants.INIT_DATA_PAIR_SEPARATOR,!0),a={TerminalKey:this.terminalKey,Amount:this.amount,OrderId:this.orderId,Description:this.description,Currency:this.currency,PayForm:this.payForm,CustomerKey:this.customerKey,DATA:r,PayType:this.payType};this.ip&&(a[TcsParameters.IP]=this.ip),this.recurrent&&(a[TcsParameters.RECURRENT]="Y"),this.bill&&(a[TcsParameters.BILL]="Y"),this.generateToken?this.generateToken(a,function(r){a[TcsParameters.TOKEN]=r,t.ajaxCall(TcsUrl.INIT_URL,a,e,"json")}):t.ajaxCall(TcsUrl.INIT_URL,a,e,"json")},TcsPay.prototype.redirectWithForm=function(e,t){var r=$('<form />');r.prop('action',e),r.prop('method','post'),$.each(t,function(e,t){r.append($('<input type="hidden"/>').prop('name',e).val(t))}),$(document.body).append(r),r.submit()},TcsPay.prototype.getCardData=function(e){var t=e.find("#form-card-number-input").val(),r=e.find("#form-month-input").val(),a=e.find("#form-year-input").val();r=("0"+r).slice(-2),a=("0"+a).slice(-2);var n=e.find("#form-cvc-input").val(),s=e.find("#form-cardholder-input").val(),i={};return i[TcsParameters.PAN]=t.replace(/\s+/g,''),i[TcsParameters.EXP_DATE]=r+a,s&&(i[TcsParameters.CARD_HOLDER]=s),i[TcsParameters.CVV]=n,this.concatenateData(i,TcsConstants.CARD_DATA_KEY_VALUE_SEPARATOR,TcsConstants.CARD_DATA_PAIR_SEPARATOR,!1)},TcsPay.prototype.encryptCardData=function(e){var t=new JSEncrypt;return t.setPublicKey(this.rcaPublicKey),t.encrypt(e)},TcsPay.prototype.concatenateData=function(e,t,r,a){var n="";return $.each(e,function(e,s){var i=e+t+(a?encodeURIComponent(s):s);n&&(n+=r),n+=i}),n},TcsPay.prototype.onFail=function(e,t,r,a){a===TcsUrl.FINISH_AUTORIZE_URL&&$("#form-submit").removeAttr('disabled','disabled'),alert("Ошибка соединения с сервером банка")},TcsPay.prototype.onError=function(e,t,r,a){a===TcsUrl.FINISH_AUTORIZE_URL&&$("#form-submit").removeAttr('disabled','disabled'),alert("Ошибка ("+e+"): "+t+" "+r)},TcsPay.prototype.onAjaxCallStart=function(e){e===TcsUrl.FINISH_AUTORIZE_URL&&$("#form-submit").attr('disabled','disabled')},TcsPay.prototype.onAjaxCallFinish=function(e){},TcsPay.prototype.getIp=function(e){e()},TcsPay.prototype.ajaxCall=function(e,t,r,a,n){var s=this;this.inProgress||(this.inProgress=!0,this.onAjaxCallStart(e),$.ajax({type:n||"POST",url:e,data:t,timeout:TcsConstants.CONNECTION_TIMEOUT_MS,success:function(t,a,n){if(s.inProgress=!1,s.isBusinessError(n)){var i=$.parseJSON(n.responseText);s.onError(i[TcsParameters.ERROR_CODE],i[TcsParameters.MESSAGE],i[TcsParameters.DETAILS],e)}else s.onAjaxCallFinish(e),r(t,a,n)},error:function(t,r,a){if(s.inProgress=!1,s.isBusinessError(t)){var n=$.parseJSON(t.responseText);s.onError(n[TcsParameters.ERROR_CODE],n[TcsParameters.MESSAGE],n[TcsParameters.DETAILS],e)}else s.onFail(t,r,a,e)},dataType:a||null}))},TcsPay.prototype.isBusinessError=function(e){return!(!((e.getResponseHeader("content-type")||"").indexOf('json')>-1)||"0"===$.parseJSON(e.responseText)[TcsParameters.ERROR_CODE])};